{% extends "base.html" %}
{% block content %}

<section class="chat-container">
    <div class="chat-wrapper">

        <!-- Messages Area -->
        <div class="chat-messages" id="chatMessages">

            <!-- Welcome Bot Message -->
            <div class="message bot">
                <div class="message-bubble">
                    Hello üëã I'm NeuralSync AI. Ask me anything with full transparency.

                    <div class="hash-badge">
                        sha256: 9af23b1c34d12f5a9c3a...
                    </div>
                </div>
                <div class="message-time" id="welcomeTime"></div>
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator" style="display:none;">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <span>NeuralSync is thinking...</span>
            </div>

        </div>

        <!-- Input Area -->
        <div class="chat-input-wrapper">
            <form class="chat-input-group" id="chatForm">
                <input type="text" id="userInput" placeholder="Ask about transparent AI..." autocomplete="off" required>
                <button type="submit" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>

    </div>
</section>

<script>
    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    // Set welcome time
    document.getElementById("welcomeTime").innerText = getCurrentTime();

    const chatForm = document.getElementById("chatForm");
    const userInput = document.getElementById("userInput");
    const chatMessages = document.getElementById("chatMessages");
    const typingIndicator = document.getElementById("typingIndicator");
    const sendBtn = document.getElementById("sendBtn");

    chatForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const message = userInput.value.trim();
        if (!message) return;

        // USER MESSAGE
        const userDiv = document.createElement("div");
        userDiv.className = "message user";
        userDiv.innerHTML = `
        <div class="message-bubble">
            ${message}
        </div>
        <div class="message-time">${getCurrentTime()}</div>
    `;
        chatMessages.appendChild(userDiv);

        userInput.value = "";
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Show typing indicator
        typingIndicator.style.display = "flex";
        userInput.disabled = true;
        sendBtn.disabled = true;

        try {
            const response = await fetch("/api/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            typingIndicator.style.display = "none";

            if (!data.success) {
                throw new Error("API Error");
            }

            // BOT MESSAGE
            const botDiv = document.createElement("div");
            botDiv.className = "message bot";
            botDiv.innerHTML = `
            <div class="message-bubble">
                ${data.bot_response}

                <div class="hash-badge">
                    sha256: ${data.short_hash}
                </div>
            </div>
            <div class="message-time">${getCurrentTime()}</div>
        `;
            chatMessages.appendChild(botDiv);

        } catch (error) {
            typingIndicator.style.display = "none";

            const errorDiv = document.createElement("div");
            errorDiv.className = "message bot";
            errorDiv.innerHTML = `
            <div class="message-bubble">
                ‚ö†Ô∏è Error connecting to AI. Please try again.
            </div>
            <div class="message-time">${getCurrentTime()}</div>
        `;
            chatMessages.appendChild(errorDiv);
        }

        chatMessages.scrollTop = chatMessages.scrollHeight;
        userInput.disabled = false;
        sendBtn.disabled = false;
        userInput.focus();
    });
</script>

{% endblock %}